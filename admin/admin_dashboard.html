<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Dashboard - CRUD Management</title>
<link href="../assets/style.css" rel="stylesheet">
<style>
body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;font-family:'Poppins',sans-serif;position:relative}
body::before{content:'';position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:700px;height:700px;background-image:url('../logo.png');background-size:contain;background-repeat:no-repeat;background-position:center;opacity:0.08;z-index:0;pointer-events:none}
body>*{position:relative;z-index:1}
.container{max-width:1400px;margin:0 auto}
.header{background:rgba(255,255,255,0.95);padding:20px;border-radius:12px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
.header h1{margin:0;color:#667eea}
.btn{background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;transition:transform 0.2s}
.btn:hover{transform:scale(1.05)}
.btn-danger{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
.btn-success{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)}
.tabs{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.tab-btn{background:rgba(255,255,255,0.9);padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s}
.tab-btn.active{background:linear-gradient(135deg,#667eea,#764ba2);color:white}
.card{background:rgba(255,255,255,0.95);padding:24px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);margin-bottom:20px}
.table-container{overflow-x:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:12px;text-align:left;border-bottom:1px solid #e0e0e0}
th{background:linear-gradient(135deg,#667eea,#764ba2);color:white;font-weight:600}
tr:hover{background:#f5f5f5}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center}
.modal-content{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);padding:30px;border-radius:12px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.3)}
.form-group{margin-bottom:16px}
.form-group label{display:block;margin-bottom:6px;font-weight:600;color:#333}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px}
.form-group textarea{min-height:80px;resize:vertical}
.form-actions{display:flex;gap:10px;margin-top:20px}
.status{padding:10px;border-radius:6px;margin-bottom:15px;display:none}
.status.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
.status.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>
<img src="../logo.png" alt="Smart Crop Planner Logo" style="height:40px;width:auto;object-fit:contain;margin-right:12px" onerror="this.style.display='none'"/>
Admin Dashboard - Database Management
</h1>
<div style="display:flex;align-items:center;gap:12px">
<img src="../profile.png" alt="Profile" id="admin-profile-img" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #667eea" onerror="this.style.display='none'"/>
<span id="admin-name" style="font-weight:600"></span>
<button class="btn btn-success" onclick="openProfileModal()">Edit Profile</button>
<button class="btn btn-danger" onclick="logout()">Logout</button>
</div>
</div>

<div id="status" class="status"></div>

<div class="tabs">
<button class="tab-btn active" onclick="switchTable('weather_data')">Weather Data</button>
<button class="tab-btn" onclick="switchTable('crops')">Crops</button>
<button class="tab-btn" onclick="switchTable('users')">Users</button>
<button class="tab-btn" onclick="switchTable('admins')">Admins</button>
<button class="tab-btn" onclick="switchTable('user_searches')">User Searches</button>
</div>

<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h2 id="table-title">Weather Data</h2>
<button class="btn btn-success" onclick="openModal('create')">+ Add New</button>
</div>
<div class="table-container">
<table id="data-table">
<thead id="table-head"></thead>
<tbody id="table-body"></tbody>
</table>
</div>
</div>
</div>

<div id="modal" class="modal">
<div class="modal-content">
<h2 id="modal-title">Create Record</h2>
<form id="modal-form"></form>
<div class="form-actions">
<button type="button" class="btn" onclick="closeModal()">Cancel</button>
<button type="button" class="btn btn-success" onclick="saveRecord()">Save</button>
</div>
</div>
</div>

<!-- Profile Edit Modal -->
<div id="profile-modal" class="modal" style="display:none">
<div class="modal-content" style="background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);box-shadow:0 8px 32px rgba(0,0,0,0.3)">
<h2 style="margin-top:0;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,0.3)">Edit Profile</h2>
<form id="profile-form">
<div class="form-group">
<label style="color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.3)">Username</label>
<input type="text" id="profile-username" required style="background:rgba(255,255,255,0.9);border:1px solid rgba(255,255,255,0.3)"/>
</div>
<div class="form-group">
<label style="color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.3)">Role</label>
<input type="text" id="profile-role" disabled style="background:rgba(255,255,255,0.5);border:1px solid rgba(255,255,255,0.3)"/>
</div>
<div style="border-top:2px solid rgba(255,255,255,0.3);margin:20px 0;padding-top:20px">
<h3 style="margin-top:0;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.3);font-size:1.1rem">Change Password (Optional)</h3>
<div class="form-group">
<label style="color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.3)">Current Password</label>
<input type="password" id="profile-current-password" placeholder="Enter current password to change" style="background:rgba(255,255,255,0.9);border:1px solid rgba(255,255,255,0.3)"/>
</div>
<div class="form-group">
<label style="color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.3)">New Password</label>
<input type="password" id="profile-new-password" placeholder="Enter new password" style="background:rgba(255,255,255,0.9);border:1px solid rgba(255,255,255,0.3)"/>
</div>
<div class="form-group">
<label style="color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.3)">Confirm New Password</label>
<input type="password" id="profile-confirm-password" placeholder="Confirm new password" style="background:rgba(255,255,255,0.9);border:1px solid rgba(255,255,255,0.3)"/>
</div>
</div>
<div class="form-actions">
<button type="button" class="btn" onclick="closeProfileModal()">Cancel</button>
<button type="submit" class="btn btn-success">Save Changes</button>
</div>
</form>
</div>
</div>

<script>
let currentTable = 'weather_data';
let currentRecord = null;

let admin = JSON.parse(localStorage.getItem('admin_user') || '{}');
if(!admin || !admin.admin_id){
  window.location.href = 'admin_login.html';
}
document.getElementById('admin-name').textContent = admin.username || 'Admin';
// Load profile data into modal
document.getElementById('profile-username').value = admin.username || '';
document.getElementById('profile-role').value = admin.role || 'data_entry';

function showStatus(message, type = 'success'){
  const status = document.getElementById('status');
  status.textContent = message;
  status.className = 'status ' + type;
  status.style.display = 'block';
  setTimeout(() => status.style.display = 'none', 3000);
}

function switchTable(table){
  currentTable = table;
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('table-title').textContent = table.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
  loadData();
}

async function loadData(){
  try{
    const res = await fetch(`../api/admin_crud.php?table=${currentTable}`);
    const data = await res.json();
    if(!data.success){
      showStatus(data.error || 'Failed to load data', 'error');
      return;
    }
    renderTable(data.data || []);
  }catch(err){
    showStatus('Error loading data: ' + err.message, 'error');
  }
}

// Function to format season to common seasons: Summer, Winter, Rainy, Monsoon
function formatSeason(season){
  if(!season) return 'N/A';
  const seasonMap = {
    'Winter': 'Winter', 'Rabi': 'Winter',
    'Summer': 'Summer', 'Zaid': 'Summer', 'Pre-Monsoon': 'Summer',
    'Monsoon': 'Monsoon',
    'Rainy': 'Rainy', 'Kharif': 'Rainy', 'Post-Monsoon': 'Rainy'
  };
  return seasonMap[season] || season;
}

// Function to format month number to month name
function formatMonth(month){
  if(month === null || month === undefined || month === '') return 'N/A';
  const monthNum = parseInt(month);
  if(isNaN(monthNum) || monthNum < 1 || monthNum > 12) return month;
  const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  return monthNames[monthNum] || month;
}

function renderTable(rows){
  if(rows.length === 0){
    document.getElementById('table-body').innerHTML = '<tr><td colspan="10" style="text-align:center;padding:40px">No records found</td></tr>';
    return;
  }
  // Filter headers: exclude password, and exclude created_at for tables other than users and admins
  let headers = Object.keys(rows[0]).filter(k => k !== 'password');
  if(currentTable !== 'users' && currentTable !== 'admins'){
    headers = headers.filter(k => k !== 'created_at');
  }
  // Remove avg_yield_per_hectare, min_temperature, max_temperature, min_rainfall, max_rainfall from crops table display
  if(currentTable === 'crops'){
    headers = headers.filter(k => k !== 'avg_yield_per_hectare' && k !== 'min_temperature' && k !== 'max_temperature' && k !== 'min_rainfall' && k !== 'max_rainfall');
  }
  // Remove location, soil_type, month from user_searches table display
  if(currentTable === 'user_searches'){
    headers = headers.filter(k => k !== 'location' && k !== 'soil_type' && k !== 'month');
  }
  
  const thead = document.getElementById('table-head');
  thead.innerHTML = '<tr>' + headers.map(h => `<th>${h.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</th>`).join('') + '<th>Actions</th></tr>';
  
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = rows.map(row => {
    const cells = headers.map(h => {
      let val = row[h];
      if(val === null || val === undefined) val = '-';
      // Format season column
      if(h === 'season' && val && val !== '-'){
        val = formatSeason(val);
      }
      // Format month column to show month name instead of number
      if(h === 'month' && val && val !== '-'){
        val = formatMonth(val);
      }
      if(typeof val === 'string' && val.length > 50) val = val.substring(0, 50) + '...';
      return `<td>${val}</td>`;
    }).join('');
    const idField = currentTable === 'users' ? 'user_id' : (currentTable === 'admins' ? 'admin_id' : (currentTable === 'crops' ? 'crop_id' : (currentTable === 'user_searches' ? 'search_id' : 'weather_id')));
    return `<tr>${cells}<td><button class="btn" onclick="openModal('edit', ${row[idField]})" style="padding:6px 12px;margin-right:5px">Edit</button><button class="btn btn-danger" onclick="deleteRecord(${row[idField]})" style="padding:6px 12px">Delete</button></td></tr>`;
  }).join('');
}

function openModal(mode, id = null){
  currentRecord = id;
  document.getElementById('modal-title').textContent = mode === 'create' ? 'Create New Record' : 'Edit Record';
  document.getElementById('modal').style.display = 'flex';
  
  const form = document.getElementById('modal-form');
  const fields = getTableFields();
  form.innerHTML = fields.map(f => {
    if(f === 'password' && mode === 'edit') return `<div class="form-group"><label>${f.replace(/_/g, ' ')} (leave blank to keep current)</label><input type="password" name="${f}" id="field-${f}"></div>`;
    if(f.includes('id') || f === 'last_login_at') return '';
    // Only exclude created_at for tables other than users and admins
    if(f === 'created_at' && currentTable !== 'users' && currentTable !== 'admins') return '';
    // For season field, add dropdown with common seasons
    if(f === 'season'){
      return `<div class="form-group"><label>${f.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</label><select name="${f}" id="field-${f}"><option value="">Select Season</option><option value="Winter">Winter</option><option value="Summer">Summer</option><option value="Rainy">Rainy</option><option value="Monsoon">Monsoon</option></select></div>`;
    }
    // For month field, add dropdown with months 1-12
    if(f === 'month'){
      const months = [
        {value: 1, name: 'January'}, {value: 2, name: 'February'}, {value: 3, name: 'March'},
        {value: 4, name: 'April'}, {value: 5, name: 'May'}, {value: 6, name: 'June'},
        {value: 7, name: 'July'}, {value: 8, name: 'August'}, {value: 9, name: 'September'},
        {value: 10, name: 'October'}, {value: 11, name: 'November'}, {value: 12, name: 'December'}
      ];
      return `<div class="form-group"><label>${f.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</label><select name="${f}" id="field-${f}"><option value="">Select Month</option>${months.map(m => `<option value="${m.value}">${m.name}</option>`).join('')}</select></div>`;
    }
    const type = f.includes('description') || f.includes('excerpt') ? 'textarea' : (f.includes('date') ? 'date' : (f.includes('password') ? 'password' : 'text'));
    const input = type === 'textarea' ? `<textarea name="${f}" id="field-${f}"></textarea>` : `<input type="${type}" name="${f}" id="field-${f}">`;
    return `<div class="form-group"><label>${f.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</label>${input}</div>`;
  }).join('');
  
  if(mode === 'edit' && id){
    loadRecord(id);
  }
}

async function loadRecord(id){
  try{
    const res = await fetch(`../api/admin_crud.php?table=${currentTable}`);
    const data = await res.json();
    if(data.success){
      const record = data.data.find(r => {
        const idField = currentTable === 'users' ? 'user_id' : (currentTable === 'admins' ? 'admin_id' : (currentTable === 'crops' ? 'crop_id' : (currentTable === 'user_searches' ? 'search_id' : 'weather_id')));
        return r[idField] == id;
      });
      if(record){
        Object.keys(record).forEach(key => {
          const field = document.getElementById(`field-${key}`);
          if(field && key !== 'password'){
            // For season field, format to common season before setting value
            if(key === 'season' && record[key]){
              const formattedSeason = formatSeason(record[key]);
              field.value = formattedSeason;
            }else if(key === 'month' && record[key]){
              // For month field, ensure it's set as a number for the dropdown
              field.value = parseInt(record[key]) || record[key];
            }else{
              field.value = record[key] || '';
            }
          }
        });
      }
    }
  }catch(err){
    showStatus('Error loading record', 'error');
  }
}

function getTableFields(){
  const fieldsMap = {
    weather_data: ['location', 'month', 'temperature', 'rainfall', 'humidity', 'season'],
    crops: ['crop_name', 'suitable_soil', 'season', 'description', 'market_price_per_unit'],
    users: ['name', 'username', 'password', 'location', 'soil_type', 'contact_no'],
    admins: ['username', 'password', 'role'],
    user_searches: ['user_id', 'query_text', 'result_count']
  };
  return fieldsMap[currentTable] || [];
}

function closeModal(){
  document.getElementById('modal').style.display = 'none';
  currentRecord = null;
  document.getElementById('modal-form').innerHTML = '';
}

async function saveRecord(){
  const form = document.getElementById('modal-form');
  const formData = new FormData(form);
  const data = {};
  formData.forEach((value, key) => {
    if(value && value.trim() !== ''){
      if(key === 'month' || key.includes('temperature') || key.includes('rainfall') || key.includes('humidity') || key.includes('price') || key.includes('score') || key.includes('yield') || key.includes('user_id') || key.includes('result_count')){
        data[key] = parseFloat(value) || parseInt(value) || value;
      }else{
        data[key] = value;
      }
    }
  });
  
  if(currentRecord){
    data.id = currentRecord;
  }
  
  try{
    const method = currentRecord ? 'PUT' : 'POST';
    const res = await fetch(`../api/admin_crud.php?table=${currentTable}`, {
      method: method,
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    const result = await res.json();
    if(result.success){
      showStatus(result.message || 'Record saved successfully');
      closeModal();
      loadData();
    }else{
      showStatus(result.error || 'Failed to save record', 'error');
    }
  }catch(err){
    showStatus('Error saving record: ' + err.message, 'error');
  }
}

async function deleteRecord(id){
  if(!confirm('Are you sure you want to delete this record?')) return;
  try{
    const res = await fetch(`../api/admin_crud.php?table=${currentTable}`, {
      method: 'DELETE',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({id: id})
    });
    const result = await res.json();
    if(result.success){
      showStatus('Record deleted successfully');
      loadData();
    }else{
      showStatus(result.error || 'Failed to delete record', 'error');
    }
  }catch(err){
    showStatus('Error deleting record: ' + err.message, 'error');
  }
}

function openProfileModal(){
  // Clear password fields when opening modal
  document.getElementById('profile-current-password').value = '';
  document.getElementById('profile-new-password').value = '';
  document.getElementById('profile-confirm-password').value = '';
  document.getElementById('profile-modal').style.display = 'flex';
}

function closeProfileModal(){
  document.getElementById('profile-modal').style.display = 'none';
}

document.getElementById('profile-form').addEventListener('submit', async function(e){
  e.preventDefault();
  
  const currentPassword = document.getElementById('profile-current-password').value.trim();
  const newPassword = document.getElementById('profile-new-password').value.trim();
  const confirmPassword = document.getElementById('profile-confirm-password').value.trim();
  
  // Validate password change if any password field is filled
  if(currentPassword || newPassword || confirmPassword){
    if(!currentPassword){
      showStatus('Please enter your current password to change it', 'error');
      return;
    }
    if(!newPassword){
      showStatus('Please enter a new password', 'error');
      return;
    }
    if(newPassword.length < 6){
      showStatus('New password must be at least 6 characters long', 'error');
      return;
    }
    if(newPassword !== confirmPassword){
      showStatus('New passwords do not match', 'error');
      return;
    }
  }
  
  const profileData = {
    admin_id: admin.admin_id,
    username: document.getElementById('profile-username').value.trim()
  };
  
  if(!profileData.username){
    showStatus('Username is required', 'error');
    return;
  }
  
  // Add password fields only if provided
  if(currentPassword && newPassword){
    profileData.current_password = currentPassword;
    profileData.new_password = newPassword;
  }
  
  try{
    const res = await fetch('../api/update_admin_profile.php', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(profileData)
    });
    
    const data = await res.json();
    
    if(data.success){
      // Update admin in localStorage
      admin = {...admin, ...data.admin};
      localStorage.setItem('admin_user', JSON.stringify(admin));
      document.getElementById('admin-name').textContent = admin.username || 'Admin';
      // Clear password fields
      document.getElementById('profile-current-password').value = '';
      document.getElementById('profile-new-password').value = '';
      document.getElementById('profile-confirm-password').value = '';
      showStatus('Profile updated successfully!', 'success');
      closeProfileModal();
    }else{
      showStatus(data.error || 'Failed to update profile', 'error');
    }
  }catch(err){
    console.error('Error updating profile', err);
    showStatus('Error connecting to server. Please try again.', 'error');
  }
});

function logout(){
  localStorage.removeItem('admin_token');
  localStorage.removeItem('admin_user');
  window.location.href = '../index.html';
}

loadData();
</script>
</body>
</html>
